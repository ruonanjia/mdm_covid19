---
title: "R Notebook"
author: ruonanjia
---

```{r}
rm(list = ls())
```


Install packages
```{r}
# Download package tarball from CRAN archive

url <- "https://cran.r-project.org/src/contrib/Archive/zipcode/zipcode_1.0.tar.gz"
pkgFile <- "zipcode_1.0.tar.gz"
download.file(url = url, destfile = pkgFile)

# Install dependencies

install.packages(c("ada", "ipred", "evd"))

# Install package
install.packages(pkgs=pkgFile, type="source", repos=NULL)

# Delete package tarball
unlink(pkgFile)
```


load library
```{r}
library(ggplot2)
library(zipcode) # install only available through archive
library(maps)
library(ggpubr)
library("PerformanceAnalytics") # for chart correlation
library(usmap) # for plotting data us maps
library(scales) # for muted() function
library(tidyverse)
```

# load data
```{r}
# setwd("E:/Ruonan/Projects in the lab/mdm_covid19/batch_data")
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
load("data_all_444sub_rename.Rda")
load("data_all_444sub_rename_header.Rda")
load("data_all_444sub_attitude.Rda")

# combine data
data.all <- merge(data.all, data.attitude, by = "mTurkCode")
data.all$age <- as.numeric(as.character(data.all$age)) + 17 # correct coding
rm(data.attitude)
```

save into spread sheet
```{r}
# setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
# write.csv(header,"data_header.csv", row.names = FALSE)
# write.csv(data.all,"data_all_444sub.csv", row.names = FALSE)
```

# Preprocess some data columns, run the following chunks before further analysis:

Separate young and old, compare with 60 yr
```{r}
data.all$is.young <- 1
data.all$is.young[data.all$age >= 60] = 0 
data.all$is.young <- as.factor(data.all$is.young)
```

Clean zipcode
```{r}
# clean zipcode
data.all$zip_postal_code <- as.numeric(as.character(data.all$zip_postal_code))
data(zipcode)
data.all$zipcode<- clean.zipcodes(data.all$zip_postal_code)
```
End of preprocessing


take only the first response of the repeated subjects
```{r}
# dupli <- data.all$WorkerId[duplicated(data.all$WorkerId)] 
# dupli
# length(dupli)
# 
# data.repeat <- data.all[is.element(data.all$WorkerId, dupli),]
# nrow(data.repeat)
```

Look at column names
```{r}
colnames(data.all)
```

# composite score for ambiguity attitude

## select and change data type to integer
```{r}

# # change in total time of checking news per day (not sure if subtracting is proper because scale is not linear)
# news_change <- as.numeric(as.character(data.all$ambig1_news_perday)) - as.numeric(as.character(data.all$ambig1_news_before))
# 
# news_change

ambig_score <- data.all %>% select(mTurkCode, 
                                   # news
                                   ambig1_news_perday, ambig1_news_before, ambig1_track_deaths,
                                   # how well-informed
                                   ambig1_gov_local, ambig1_you, ambig1_gov_national, ambig1_scientists, ambig1_health_worker, ambig1_economists, ambig1_family_friend,
                                   # reaction
                                   # ambig1_react_nation, ambig1_react_state, ambig1_react_science, ambig1_react_worker, ambig1_react_econ, ambig1_react_you,
                                   #health or economics
                                   # ambig2_health_impact, ambig2_economics,
                                   # current state
                                   ambig3_current_covi1, ambig3_current_covi2,
                                   # how likely will be infected
                                   ambig3_you_infect, ambig3_family_infect
                                   )

```

correct factor levels and turn into integer
```{r}
ambig_score$mTurkCode <- as.factor(as.character(ambig_score$mTurkCode))

ambig_score$ambig1_news_perday <- as.integer(as.character(ambig_score$ambig1_news_perday))
ambig_score$ambig1_news_before <- as.integer(as.character(ambig_score$ambig1_news_before))
ambig_score$ambig1_track_deaths <- as.integer(as.character(ambig_score$ambig1_track_deaths))

ambig_score$ambig1_gov_local <- as.integer(as.character(ambig_score$ambig1_gov_local))
ambig_score$ambig1_you <- as.integer(as.character(ambig_score$ambig1_you))
ambig_score$ambig1_gov_national <- as.integer(as.character(ambig_score$ambig1_gov_national))
ambig_score$ambig1_scientists <- as.integer(as.character(ambig_score$ambig1_scientists))
ambig_score$ambig1_health_worker <- as.integer(as.character(ambig_score$ambig1_health_worker))
ambig_score$ambig1_economists <- as.integer(as.character(ambig_score$ambig1_economists))
ambig_score$ambig1_family_friend <- as.integer(as.character(ambig_score$ambig1_family_friend))


ambig_score$ambig3_current_covi1 <- as.integer(as.character(ambig_score$ambig3_current_covi1))
ambig_score$ambig3_current_covi2 <- as.integer(as.character(ambig_score$ambig3_current_covi2))

ambig_score$ambig3_you_infect <- as.integer(as.character(ambig_score$ambig3_you_infect))
ambig_score$ambig3_family_infect <- as.integer(as.character(ambig_score$ambig3_family_infect))


# # why the following does not work??
# ambig_score %>% mutate_at(1, droplevels)
# ambig_score %>% mutate_at(c("mTurkCode"), factor)
# 
# ambig_score %>% mutate_at(vars(matches("ambig1")), as.character)
# ambig_score %>% mutate_at(vars(matches("ambig1")), as.ordered)
# 
# ambig_score$mTurkCode
# information$ambig1_news_before
# 
# droplevels(ambig_score$mTurkCode)
```


```{r}
ambig_score
```

```{r}
colnames(ambig_score)
```


## correct scale
Inspect each item, make sure which scales are consistent
e.g, smaller number indicate less information (ambiguity)
```{r}
# 1-6 nonlinear duraion, 1 (less than 15 min) ~ 6 (over 5 hours)
ambig_score$ambig1_news_perday
ambig_score$ambig1_news_before

# 1-7 nonlinear duration, 1(Several times a day) ~ 7 (rarely or never)
ambig_score$ambig1_track_deaths

# 1-7 likert scale, 1 (very-well informed) ~ 7(Very uninformed)
ambig_score$ambig1_gov_local
ambig_score$ambig1_you
ambig_score$ambig1_gov_national
ambig_score$ambig1_scientists
ambig_score$ambig1_health_worker
ambig_score$ambig1_economists
ambig_score$ambig1_family_friend

# 1-7 likert scale, 1(Extremely severe) ~ 7 (not at all severe)
ambig_score$ambig3_current_covi1
ambig_score$ambig3_current_covi2

# 1-7 likert scale, 2(extremely likely) ~ 8 (extremely unlikely)
# 1: already confirmed infection by test, 9: don't know 
ambig_score$ambig3_you_infect
ambig_score$ambig3_family_infect

```

correct scale
larger number should indicate less information (more ambiguity)
```{r}
# 1-6
ambig_score$ambig1_news_perday <- 7-ambig_score$ambig1_news_perday
ambig_score$ambig1_news_before <- 7-ambig_score$ambig1_news_before

# 1-7
ambig_score$ambig3_current_covi1 <- 8-ambig_score$ambig3_current_covi1
ambig_score$ambig3_current_covi2 <- 8-ambig_score$ambig3_current_covi2

# 2-8, compare with 5 (most uncertain)
ambig_score$ambig3_you_infect[ambig_score$ambig3_you_infect == 9 | ambig_score$ambig3_you_infect == 1] <- NA 
ambig_score$ambig3_family_infect[ambig_score$ambig3_family_infect == 9 | ambig_score$ambig3_family_infect == 1] <- NA 

ambig_score$ambig3_you_infect[ambig_score$ambig3_you_infect <= 5 & !is.na(ambig_score$ambig3_you_infect)] <- ambig_score$ambig3_you_infect[ambig_score$ambig3_you_infect <= 5 & !is.na(ambig_score$ambig3_you_infect)] - 1

ambig_score$ambig3_you_infect[ambig_score$ambig3_you_infect > 5 & !is.na(ambig_score$ambig3_you_infect)] <- 9-ambig_score$ambig3_you_infect[ambig_score$ambig3_you_infect > 5 & !is.na(ambig_score$ambig3_you_infect)]

ambig_score$ambig3_family_infect[ambig_score$ambig3_family_infect <= 5 & !is.na(ambig_score$ambig3_family_infect)] <- ambig_score$ambig3_family_infect[ambig_score$ambig3_family_infect <= 5 & !is.na(ambig_score$ambig3_family_infect)] - 1

ambig_score$ambig3_family_infect[ambig_score$ambig3_family_infect > 5 & !is.na(ambig_score$ambig3_family_infect)] <- 9-ambig_score$ambig3_family_infect[ambig_score$ambig3_family_infect > 5 & !is.na(ambig_score$ambig3_family_infect)]

```

```{r}
ambig_score
View(ambig_score)
```


## sum up
```{r}

# some columns have NA, average clusters before summing up
# colnames(ambig_score)
# colnames(ambig_score)[5:11]

# change in news consumption frequency
ambig_score$news <- ambig_score$ambig1_news_perday - ambig_score$ambig1_news_before

# average of how well-informed
ambig_score$well_informed <- rowMeans(ambig_score[ , 5:11], na.rm = TRUE)

# average of current situation
ambig_score$current_situ <- rowMeans(ambig_score[ , 12:13], na.rm = TRUE)

# average of likely to be infected
ambig_score$infect <- rowMeans(ambig_score[,14:15], na.rm = TRUE)

# ambig_score

# average
ambig_score$ambig_score <- rowMeans(ambig_score[ , 16:19], na.rm = TRUE)

# ambig_score$ambig_score
```

## distribution of ambiguity score
```{r}
ggplot(ambig_score, aes(x=ambig_score)) +
  geom_histogram()
```

```{r}
nrow(ambig_score)
ambig_score$is.young <- data.all$is.young
ggplot(ambig_score, aes(x=ambig_score, color=is.young, fill=is.young)) +
  geom_histogram(alpha=0.5, position="stack")

ggplot(ambig_score, aes(x=ambig_score, color=is.young, fill=is.young)) +
  geom_histogram(alpha=0.5, position="identity")
```

## ambiguity score on map
```{r}
# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(ambig_score=data.all$ambig_score),list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$ambig_score[idx] <- mean(geo$ambig_score[geo$state==state_all[idx]],na.rm=TRUE)
}

# plot
plot_usmap(data=geo_state, regions="states",values="ambig_score") +
  # scale_fill_gradient2(limits=c(-1,3),midpoint=0,low=muted("blue"),high=muted("red")) +
  ggtitle("Ambiguity Composite Score") +
  labs(fill = "More Ambiguous (Lighter) \n~ \nLess Ambiguous (Darker)") +
  theme(legend.position = "right")
```


# Composite ambiguity score and other measures

combine table
```{r}
# colnames(ambig_score)
ambig_score_small <- ambig_score[,c(1,16:20)]

# nrow(ambig_score_small)

data.all <- merge(data.all, ambig_score, by="mTurkCode")
```

```{r}
colnames(data.all)
```

## age
```{r}
ggplot(data.all, aes(x=age, y=ambig_score)) + 
  geom_point()+
  geom_smooth(method="lm")

# separate young and old
ggplot(data.all, aes(x=age, y=ambig_score, color=is.young)) + 
  geom_point()+
  geom_smooth(method="lm")
```

mask of subjects inclusion
```{r}
mask_med <- data.all$error.med < 0.5
mask_mon <- data.all$error.mon < 0.5
```


## ambiguity attitude
```{r}
ggplot(data.all[mask_med,], aes(x=ambig_score, y=ambig_corr.med)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med,], aes(x=ambig_score, y=ambig_corr.med, color = is.young)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_mon,], aes(x=ambig_score, y=ambig_corr.mon)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_mon,], aes(x=ambig_score, y=ambig_corr.mon, color = is.young)) + 
  geom_point()+
  geom_smooth(method="lm")

```

## risk attitude
```{r}
ggplot(data.all[mask_med,], aes(x=ambig_score, y=risk.med)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med,], aes(x=ambig_score, y=risk.med, color = is.young)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_mon,], aes(x=ambig_score, y=risk.mon)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_mon,], aes(x=ambig_score, y=risk.mon, color = is.young)) + 
  geom_point()+
  geom_smooth(method="lm")

```

## correlation bewteen monetary and medical attitudes
```{r}
ggplot(data.all[mask_med & mask_mon,], aes(x=risk.mon, y=risk.med)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med & mask_mon,], aes(x=risk.mon, y=risk.med, color=is.young)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med & mask_mon,], aes(x=ambig_corr.mon, y=ambig_corr.med)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med & mask_mon,], aes(x=ambig_corr.mon, y=ambig_corr.med, color=is.young)) + 
  geom_point()+
  geom_smooth(method="lm")
```

## correlation bewteen risk and ambiguity attitudes
```{r}
ggplot(data.all[mask_mon,], aes(x=risk.mon, y=ambig_corr.mon)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_mon,], aes(x=risk.mon, y=ambig_corr.mon, color=is.young)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med,], aes(x=risk.med, y=ambig_corr.med)) + 
  geom_point()+
  geom_smooth(method="lm")

ggplot(data.all[mask_med,], aes(x=risk.med, y=ambig_corr.med, color=is.young)) + 
  geom_point()+
  geom_smooth(method="lm")
```

# Cluster of ambiguity composite score
```{r}
colnames(ambig_score) 

# news, well_informed, current_situ, infect
# total: ambig_score

colnames(data.all)
```

mask of subjects inclusion
```{r}
mask_med <- data.all$error.med < 0.5 
mask_mon <- data.all$error.mon < 0.5

mask_med_young <- data.all$error.med < 0.5 & data.all$is.young == 1  
mask_mon_young <- data.all$error.mon < 0.5 & data.all$is.young == 1

mask_med_old <- data.all$error.med < 0.5 & data.all$is.young == 0
mask_mon_old <- data.all$error.mon < 0.5 & data.all$is.young == 0
```

```{r}
# monetary
chart.Correlation(data.all[mask_mon, c(355,356,407:411)])

# medical
chart.Correlation(data.all[mask_med, c(357,358,407:411)])

# monetary, young
chart.Correlation(data.all[mask_mon_young, c(355,356,407:411)])

# medical, young
chart.Correlation(data.all[mask_med_young, c(357,358,407:411)])

# monetary, old
chart.Correlation(data.all[mask_mon_old, c(355,356,407:411)])

# medical, old
chart.Correlation(data.all[mask_med_old, c(357,358,407:411)])

```

# PCA of ambiguity score

## select items and preprocess
```{r}
ambig_pca <- data.all %>% select(mTurkCode, 
                                   # news
                                   ambig1_news_perday, ambig1_news_before, ambig1_track_deaths,
                                   # how well-informed
                                   ambig1_gov_local, ambig1_you, ambig1_gov_national, ambig1_scientists, ambig1_health_worker, ambig1_economists, ambig1_family_friend,
                                   # reaction
                                   ambig1_react_nation, ambig1_react_state, ambig1_react_science, ambig1_react_worker, ambig1_react_econ, ambig1_react_you,
                                   #health or economics
                                   ambig2_health_impact, ambig2_economics,
                                   # current situation
                                   ambig3_current_covi1, ambig3_current_covi2,
                                   # how likely will be infected
                                   ambig3_you_infect, ambig3_family_infect,
                                   # how much is your daily life affected
                                   ambig3_daily_affect,
                                   # how would you feel if you got infected
                                   ambig3_feel_infect
                                   )
```

```{r}
colnames(ambig_pca)
```


correct factor levels and turn into integer
```{r}
ambig_pca$mTurkCode <- as.factor(as.character(ambig_pca$mTurkCode))

ambig_pca$ambig1_news_perday <- as.integer(as.character(ambig_pca$ambig1_news_perday))
ambig_pca$ambig1_news_before <- as.integer(as.character(ambig_pca$ambig1_news_before))
ambig_pca$ambig1_track_deaths <- as.integer(as.character(ambig_pca$ambig1_track_deaths))

ambig_pca$ambig1_gov_local <- as.integer(as.character(ambig_pca$ambig1_gov_local))
ambig_pca$ambig1_you <- as.integer(as.character(ambig_pca$ambig1_you))
ambig_pca$ambig1_gov_national <- as.integer(as.character(ambig_pca$ambig1_gov_national))
ambig_pca$ambig1_scientists <- as.integer(as.character(ambig_pca$ambig1_scientists))
ambig_pca$ambig1_health_worker <- as.integer(as.character(ambig_pca$ambig1_health_worker))
ambig_pca$ambig1_economists <- as.integer(as.character(ambig_pca$ambig1_economists))
ambig_pca$ambig1_family_friend <- as.integer(as.character(ambig_pca$ambig1_family_friend))


ambig_pca$ambig1_react_nation <- as.integer(as.character(ambig_pca$ambig1_react_nation))
ambig_pca$ambig1_react_state <- as.integer(as.character(ambig_pca$ambig1_react_state))
ambig_pca$ambig1_react_science <- as.integer(as.character(ambig_pca$ambig1_react_science))
ambig_pca$ambig1_react_worker <- as.integer(as.character(ambig_pca$ambig1_react_worker))
ambig_pca$ambig1_react_econ <- as.integer(as.character(ambig_pca$ambig1_react_econ))
ambig_pca$ambig1_react_you <- as.integer(as.character(ambig_pca$ambig1_react_you))


ambig_pca$ambig2_health_impact <- as.integer(as.character(ambig_pca$ambig2_health_impact))
ambig_pca$ambig2_economics <- as.integer(as.character(ambig_pca$ambig2_economics))

ambig_pca$ambig3_current_covi1 <- as.integer(as.character(ambig_pca$ambig3_current_covi1))
ambig_pca$ambig3_current_covi2 <- as.integer(as.character(ambig_pca$ambig3_current_covi2))

ambig_pca$ambig3_you_infect <- as.integer(as.character(ambig_pca$ambig3_you_infect))
ambig_pca$ambig3_family_infect <- as.integer(as.character(ambig_pca$ambig3_family_infect))

ambig_pca$ambig3_daily_affect <- as.integer(as.character(ambig_pca$ambig3_daily_affect))
ambig_pca$ambig3_feel_infect <- as.integer(as.character(ambig_pca$ambig3_feel_infect))

# # why the following does not work??
# ambig_score %>% mutate_at(1, droplevels)
# ambig_score %>% mutate_at(c("mTurkCode"), factor)
# 
# ambig_score %>% mutate_at(vars(matches("ambig1")), as.character)
# ambig_score %>% mutate_at(vars(matches("ambig1")), as.ordered)
# 
# ambig_score$mTurkCode
# information$ambig1_news_before
# 
# droplevels(ambig_score$mTurkCode)
```


```{r}
ambig_pca
```

```{r}
colnames(ambig_pca)
```


## correct scale
Inspect each item, make sure which scales are consistent
e.g, smaller number indicate less information (ambiguity), or something worse
```{r}
# 1-6 nonlinear duraion, 1 (less than 15 min) ~ 6 (over 5 hours)
ambig_pca$ambig1_news_perday
ambig_pca$ambig1_news_before

# 1-7 nonlinear duration, 1(Several times a day) ~ 7 (rarely or never)
ambig_pca$ambig1_track_deaths

# 1-7 likert scale, 1 (very-well informed) ~ 7(Very uninformed)
ambig_pca$ambig1_gov_local
ambig_pca$ambig1_you
ambig_pca$ambig1_gov_national
ambig_pca$ambig1_scientists
ambig_pca$ambig1_health_worker
ambig_pca$ambig1_economists
ambig_pca$ambig1_family_friend

# 1-5 likert scale, 1 (completely overacting) ~ 5 (Completely insufficient)
ambig_pca$ambig1_react_nation
ambig_pca$ambig1_react_state
ambig_pca$ambig1_react_science
ambig_pca$ambig1_react_worker
ambig_pca$ambig1_react_econ
ambig_pca$ambig1_react_you

# 1-7 likert scale, 1(Extremely) ~ 7(not at all)
ambig_pca$ambig2_health_impact
ambig_pca$ambig2_economics

# 1-7 likert scale, 1(Extremely severe) ~ 7 (not at all severe)
ambig_pca$ambig3_current_covi1
ambig_pca$ambig3_current_covi2

# 1-7 likert scale, 2(extremely likely) ~ 8 (extremely unlikely)
# 1: already confirmed infection by test, 9: don't know 
ambig_pca$ambig3_you_infect
ambig_pca$ambig3_family_infect

# 1-7 likert scale, 1(extremely) ~ 7(not at all)
ambig_pca$ambig3_daily_affect

# 1~5 scale, 1(Extremely unwell) ~ 5(not at all unwell)
ambig_pca$ambig3_feel_infect
```

correct scale
larger number should indicate less information (more ambiguity)
```{r}
# 1-6, news
ambig_pca$ambig1_news_perday <- 7-ambig_pca$ambig1_news_perday
ambig_pca$ambig1_news_before <- 7-ambig_pca$ambig1_news_before

# 1-7, current situation
ambig_pca$ambig3_current_covi1 <- 8-ambig_pca$ambig3_current_covi1
ambig_pca$ambig3_current_covi2 <- 8-ambig_pca$ambig3_current_covi2

# 2-8, compare with 5 (most uncertain)
ambig_pca$ambig3_you_infect[ambig_pca$ambig3_you_infect == 9 | ambig_pca$ambig3_you_infect == 1] <- NA 
ambig_pca$ambig3_family_infect[ambig_pca$ambig3_family_infect == 9 | ambig_pca$ambig3_family_infect == 1] <- NA 

ambig_pca$ambig3_you_infect[ambig_pca$ambig3_you_infect <= 5 & !is.na(ambig_pca$ambig3_you_infect)] <- ambig_pca$ambig3_you_infect[ambig_pca$ambig3_you_infect <= 5 & !is.na(ambig_pca$ambig3_you_infect)] - 1

ambig_pca$ambig3_you_infect[ambig_pca$ambig3_you_infect > 5 & !is.na(ambig_pca$ambig3_you_infect)] <- 9-ambig_pca$ambig3_you_infect[ambig_pca$ambig3_you_infect > 5 & !is.na(ambig_pca$ambig3_you_infect)]

ambig_pca$ambig3_family_infect[ambig_pca$ambig3_family_infect <= 5 & !is.na(ambig_pca$ambig3_family_infect)] <- ambig_pca$ambig3_family_infect[ambig_pca$ambig3_family_infect <= 5 & !is.na(ambig_pca$ambig3_family_infect)] - 1

ambig_pca$ambig3_family_infect[ambig_pca$ambig3_family_infect > 5 & !is.na(ambig_pca$ambig3_family_infect)] <- 9-ambig_pca$ambig3_family_infect[ambig_pca$ambig3_family_infect > 5 & !is.na(ambig_pca$ambig3_family_infect)]

# 1-7 likert scale, 1(extremely) ~ 7(not at all)
ambig_pca$ambig3_daily_affect <- 8 - ambig_pca$ambig3_daily_affect

# 1~5 scale, 1(Extremely unwell) ~ 5(not at all unwell)
ambig_pca$ambig3_feel_infect <- 6 - ambig_pca$ambig3_feel_infect

```

```{r}
ambig_pca
View(ambig_pca)
```

## Select data for PCA
```{r}
# some items have missing score 
# including:
# measures for state questions
# how likely you or family will be infected
# how you would feel if infected

# check how many are missing
sum(is.na(ambig_pca$ambig1_gov_local)) #10
sum(is.na(ambig_pca$ambig1_react_state)) #11
sum(is.na(ambig_pca$ambig3_current_covi2)) #11
sum(is.na(ambig_pca$ambig3_you_infect)) #7
sum(is.na(ambig_pca$ambig3_family_infect)) #16
sum(is.na(ambig_pca$ambig3_feel_infect)) #3

```

```{r}
# select items and reorganize order, for the convenience of interpreting PCA

# no state questions
array2pca_raw <- ambig_pca %>% select(# news
                                   ambig1_news_perday, ambig1_news_before, ambig1_track_deaths,
                                   # how well-informed
                                   ambig1_you, ambig1_gov_national, ambig1_scientists, ambig1_health_worker, ambig1_economists, ambig1_family_friend,
                                   # reaction
                                   ambig1_react_nation, ambig1_react_science, ambig1_react_worker, ambig1_react_econ, ambig1_react_you,
                                   #health or economics
                                   ambig2_health_impact, ambig2_economics,
                                   # current situation
                                   ambig3_current_covi1,
                                   # how likely will be infected
                                   ambig3_you_infect, ambig3_family_infect,
                                   # how much is your daily life affected
                                   ambig3_daily_affect,
                                   # how would you feel if you got infected
                                   ambig3_feel_infect
                                   )
```

get rid of na
```{r}
nrow(array2pca_raw)

array2pca <- array2pca_raw[!is.na(rowSums(array2pca_raw)),]

# number of subjects with complete data 
nrow(array2pca) # 417
ncol(array2pca) # 21 items

```

## z score
```{r}
zscored <- scale(array2pca, center = TRUE, scale = TRUE)

View(zscored)
```

## conduct PCA
There are two functions to use, princomp and prcomp
```{r}
# pcaresult <- princomp(zscored)
pcaresult <- prcomp(zscored, retx = TRUE, center = TRUE, scale. = TRUE)
summary(pcaresult)
```

Plot variance explained
```{r}
# calculate variace from eigenvalues
eigs <- pcaresult$sdev^2
var_explain <- eigs/sum(eigs)
plot(var_explain, type = "b")
comp_id = c(1:ncol(array2pca))
var_plot <- data.frame(comp_id, var_explain)

# plot variance explained
ggplot(var_plot, aes(x = comp_id, y = var_explain)) +
  geom_point() + geom_line() +
  scale_x_continuous(breaks = c(1:ncol(array2pca))) +
  theme_classic()

# plot cumulative variance
for (i in c(1:nrow(var_plot))) {
  var_plot$var_cumul[i] <- sum(var_plot$var_explain[1:i])
}

# plot cumulative variance explained
ggplot(var_plot, aes(x = comp_id, y = var_cumul)) +
  geom_point(size = 3) + geom_line() +
  scale_x_continuous(breaks = c(1:ncol(array2pca))) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(x="Number of components", y="Cumulative variance explained")

# another way to plot eigenvalues
plot(pcaresult)
```

Plot loadings
```{r}
# plot loadings
pcaload <- pcaresult$rotation[,]
# barplot(pcaload[,1], main="Component 1", ylab="Loadings", las=2)
# barplot(pcaload[,2], main="Component 2", ylab="Loadings", las=2)
# barplot(pcaload[,3], main="Component 3", ylab="Loadings", las=2)

# View(pcaload)
# load_plot <- data.frame(comp_id, pcaload[,1], pcaload[,2], pcaload[,3])
load_plot <- data.frame(pcaload)
load_plot$comp_id = comp_id

# colnames(load_plot) <- c('comp_id', 'comp1', 'comp2', 'comp3')

# bar plot of loadings
ggplot(load_plot, aes(x = comp_id, y = PC1)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = c(1:ncol(array2pca)), labels = rownames(load_plot)) +
  scale_y_continuous(limits = c(0,0.4), breaks = seq(0,0.4,0.05)) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text.x = element_text(angle = 90),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(y="Loadings", x="") +
  ggtitle('Component1')

ggplot(load_plot, aes(x = comp_id, y = PC2)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = c(1:ncol(array2pca)), labels = rownames(load_plot)) +
  scale_y_continuous(limits = c(-0.4,0.6), breaks = seq(-0.4,0.6,0.2)) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text.x = element_text(angle = 90),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(y="Loadings", x="") +
  ggtitle('Component2')

ggplot(load_plot, aes(x = comp_id, y = PC3)) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = c(1:ncol(array2pca)), labels = rownames(load_plot)) +
  # scale_y_continuous(limits = c(-0.4,1), breaks = seq(-0.4,0.85,0.2)) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text.x = element_text(angle = 90),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(y="Loadings", x="") +
  ggtitle('Component3')

```

general code
```{r}
comp_name = 'PC20'
ggplot(load_plot, aes(x = comp_id, y = eval(parse(text=comp_name)))) +
  geom_bar(stat = "identity") +
  scale_x_continuous(breaks = c(1:ncol(array2pca)), labels = rownames(load_plot)) +
  # scale_y_continuous(limits = c(-0.4,1), breaks = seq(-0.4,0.85,0.2)) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text.x = element_text(angle = 90),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(y="Loadings", x="") +
  ggtitle(comp_name)


```

## Get rotated values (component scores), and plot on PC dimensions
```{r}
# rotated values
score = pcaresult$x
View(score)
typeof(score)

# change it to data frame
score_tb <- as.data.frame.array(score)
View(score_tb)
score_tb$mTurkCode <- ambig_pca$mTurkCode[!is.na(rowSums(array2pca_raw))]
score_tb$is.young <- data.all$is.young[!is.na(rowSums(array2pca_raw))]
```

Plot PCA components
```{r}
# plot PC distribution
ggplot(score_tb, aes(x = PC1, color=is.young, fill=is.young)) +
  geom_histogram(position = "identity", alpha = 0.5, size =1, bins = 25) +
  # scale_color_manual(values = c("olivedrab","darkorange3","grey50")) +
  # scale_fill_manual(values = c("olivedrab","darkorange3","grey50")) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(x="PC1", y="Count of participant")
  
ggplot(score_tb, aes(x = PC2, color = is.young, fill = is.young)) +
  geom_histogram(position = "identity", alpha = 0.5, size =1, bins = 25) +
  # scale_color_manual(values = c("olivedrab","darkorange3","grey50")) +
  # scale_fill_manual(values = c("olivedrab","darkorange3","grey50")) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(x="PC2", y="Count of participant")

ggplot(score_tb, aes(x = PC3, color = is.young, fill = is.young)) +
  geom_histogram(position = "identity", alpha = 0.5, size =1, bins = 25) +
  # scale_color_manual(values = c("olivedrab","darkorange3","grey50")) +
  # scale_fill_manual(values = c("olivedrab","darkorange3","grey50")) +
  theme_classic() +
  theme(text = element_text(size=12), axis.line = element_line(size = 1),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10)) +
  labs(x="PC3", y="Count of participant")


# plot participants in PC space
ggplot(score_tb, aes(x=PC1, y=PC2, color=is.young)) +
  geom_point(size = 3) +
  # scale_color_manual(values = c("olivedrab","darkorange3","grey50")) +
  # scale_fill_manual(values = c("olivedrab","darkorange3","grey50")) +
  # theme_classic() +
  theme(text = element_text(size=12),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10))

ggplot(score_tb, aes(x=PC2, y=PC3, color=is.young)) +
  geom_point(size = 3) +
  # scale_color_manual(values = c("olivedrab","darkorange3","grey50")) +
  # scale_fill_manual(values = c("olivedrab","darkorange3","grey50")) +
  # theme_classic() +
  theme(text = element_text(size=12),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10))

ggplot(score_tb, aes(x=PC4, y=PC3, color=is.young)) +
  geom_point(size = 3) +
  # scale_color_manual(values = c("olivedrab","darkorange3","grey50")) +
  # scale_fill_manual(values = c("olivedrab","darkorange3","grey50")) +
  # theme_classic() +
  theme(text = element_text(size=12),
        axis.ticks = element_line(colour = "black", size = 1),
        axis.text = element_text(colour = "black", size = 10))
```

# ambiguity items PCA score correlation with uncertainty attitude
```{r}
data_pca <- merge(data.all, score_tb, by = intersect(colnames(data.all), colnames(score_tb)))
View(data_pca)
```

subject selection mask
```{r}
# mask_med <- data_pca$error.med < 0.5
# mask_mon <- data_pca$error.mon < 0.5

mask_med <- data_pca$error.med == 0
mask_mon <- data_pca$error.mon == 0
```


## general code 
Need to specify which component, which uncertainty attitude, and which domain
```{r}
pc2plot = 'PC21'
att2plot = 'ambig_corr.med'
mask = mask_med

ggplot(data_pca[mask_med,], aes(x=eval(parse(text = pc2plot)), y=eval(parse(text = att2plot)))) + 
  geom_point()+
  geom_smooth(method="lm") + 
  xlab(pc2plot) + ylab(att2plot)

cor.test(~eval(parse(text = pc2plot)) + eval(parse(text = att2plot)),
         data=data_pca[mask_med,], method="pearson")

ggplot(data_pca[mask_med,], aes(x=eval(parse(text = pc2plot)), y=eval(parse(text = att2plot)), color = is.young)) + 
  geom_point()+
  geom_smooth(method="lm") + 
  xlab(pc2plot) + ylab(att2plot)
```


# demographic block
```{r}
# colnames(data.all)
# colnames(data.all)[c(155:164,166:171, 1)]
# t(header[1, c(155:164,166:171, 353)])

# age
ggplot(data.all, aes(x=age)) +
  geom_histogram(position = "identity", bins = 20) +
  labs(x = "Age")

#size by zip
data.zipcode<-aggregate(data.frame(count=data.all$mTurkCode),list(zip=data.all$zipcode),length)
geo<- merge(data.zipcode, zipcode, by='zip')

us<-map_data('state')

# note that this does not include Hawaii
ggplot(geo,aes(longitude,latitude)) +
  geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill=NA,alpha=.35) +
  geom_point(aes(color = count),size=0.8,alpha=0.4) + 
  # scale_colour_gradient(high="dark blue", low="light blue") +
  # scale_color_continuous(breaks = c(1,2), labels = c(1,2)) +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank()) +
  xlim(-125,-65)+ylim(20,50) +
  ggtitle("Note: not including Hawaii and Alaska")
  

```


# behavioral correlation with age
```{r}
ggplot(data.all[data.all$error.med<0.5,], aes(x=age, y=ambig_corr.med)) + 
  geom_point() +
  xlab("Age") + ylab("model-free ambig medical")

ggplot(data.all[data.all$error.mon<0.5,], aes(x=age, y=ambig_corr.mon)) + 
  geom_point() +
  xlab("Age") + ylab("model-free ambig Monetary")

ggplot(data.all[data.all$error.med<0.5,], aes(x=age, y=risk.med)) + 
  geom_point() +
  xlab("Age") + ylab("model-free risk Medical")

ggplot(data.all[data.all$error.mon<0.5,], aes(x=age, y=risk.mon)) + 
  geom_point() +
  xlab("Age") + ylab("model-free risk Monetary")
```

# ambiguity block
```{r}
colnames(data.all)
ambig_col <- c(172:220)
colnames(data.all)[ambig_col]
```

## News source
```{r}
# rank news source
# ambig1_news_sources_1 - ambig1_news_sources_8_TEXT

# source of news influencing opinion
# ambig1_sourcebelief_1 - ambig1_sourcebelief_7_TEXT

# time consuming news perday
hist(as.numeric(as.character(data.all$ambig1_news_perday)))

```

## Health impact vs. economics impact
```{r}
# data.all$ambig2_health_impact
# data.all$ambig2_economics

x_labels = c("Extremely", "A lot", "Somewhat", "Uncertain", "Not much", "Not a lot", "Not at all")

ggplot(data.all, aes(x = ambig2_health_impact, fill=is.young)) +
  geom_histogram(stat="count") +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Should consider health impact") +
  scale_x_discrete(labels=x_labels) +
  xlab("Extent")

ggplot(data.all, aes(x = ambig2_economics, fill=is.young)) +
  geom_histogram(stat="count") +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  scale_x_discrete(labels=x_labels) +
  ggtitle("Should consider economics impact") +
  xlab("Extent")

ggplot(data.all, aes(x=ambig2_health_impact, y=ambig2_economics)) + 
  geom_bin2d() +
  scale_x_discrete(labels=x_labels) +
  scale_y_discrete(labels=x_labels) +
  xlab("health") + ylab("economics") + 
  ggtitle("2D histogram") +
  theme_bw()
```

Health and economics impact, correlation with uncertainty attitude
```{r}
x_labels = c("Extremely", "A lot", "Somewhat", "Uncertain", "Not much", "Not a lot", "Not at all")

# data.all$ambig2_health_impact
sum(data.all$error.med<0.5)
ggplot(data.all[data.all$error.med<0.5,], aes(x=ambig2_health_impact, y=ambig_corr.med)) + 
  geom_violin() +
  scale_x_discrete(labels=x_labels) +
  xlab("Considering health impact") + ylab("model-free ambig medical")

ggplot(data.all[data.all$error.mon<0.5,], aes(x=ambig2_health_impact, y=ambig_corr.mon)) + 
  geom_violin() +
  scale_x_discrete(labels=x_labels) +
  xlab("Considering health impact") + ylab("model-free ambig monetary")

ggplot(data.all[data.all$error.med<0.5,], aes(x=ambig2_economics, y=ambig_corr.med)) + 
  geom_violin() +
  scale_x_discrete(labels=x_labels) +
  xlab("Considering econ impact") + ylab("model-free ambig medical")

ggplot(data.all[data.all$error.mon<0.5,], aes(x=ambig2_economics, y=ambig_corr.mon)) + 
  geom_violin() +
  scale_x_discrete(labels=x_labels) +
  xlab("Considering econ impact") + ylab("model-free ambig monetary")
```

Monetary and medical attitude correlation
```{r}
sum(data.all$error.med<0.5 & data.all$error.mon<0.5)
ggplot(data.all[data.all$error.med<0.5 & data.all$error.mon<0.5,], aes(x=ambig_corr.mon, y=ambig_corr.med)) + 
  geom_point() +
  geom_smooth(method="lm")

cor(data.all$ambig_corr.mon[data.all$error.med<0.5 & data.all$error.mon<0.5],
    data.all$ambig_corr.med[data.all$error.med<0.5 & data.all$error.mon<0.5])

ggplot(data.all[data.all$error.med<0.5 & data.all$error.mon<0.5,], aes(x=risk.mon, y=risk.med)) + 
  geom_point()

ggplot(data.all[data.all$error.mon<0.5,], aes(x=risk.mon, y=ambig_corr.mon)) + 
  geom_point()

cor(data.all$risk.mon[data.all$error.mon<0.5], data.all$ambig_corr.mon[data.all$error.mon<0.5])

ggplot(data.all[data.all$error.med<0.5,], aes(x=risk.med, y=ambig_corr.med)) + 
  geom_point()

cor(data.all$risk.med[data.all$error.med<0.5], data.all$ambig_corr.med[data.all$error.med<0.5])

```

## How well informed 
```{r}
colnames(data.all)[c(194, 183, 195:199,391)]

# for (i in 193:198) {
#   data.all[, i] <- as.numeric(as.character(data.all[, i])) - 5
#   data.all[data.all[,i]!=1, i] <- data.all[data.all[,i]!=1, i] - 6
# }

my_data <- data.all[,c(194, 183, 195:199, 391)]
labels <- c("Very","Moderately","Somewhat","Uncertain","Somewhat not", "Moderately not","Very not")

colnames(my_data) <- c("self", "local_gov", "national_gov", "scientist", "healthcare", "economist", "familyfriends","is.young")

# look at histogram
# for (i in 1:length(my_data)) {
#   my_data[, i] <- as.numeric(as.character(my_data[, i]))
# }
# chart.Correlation(my_data, histogram=TRUE, pch=19)

for (i in 1:length(my_data)) {
  my_data[, i] <- as.factor(as.character(my_data[, i]))
}

# look at histogram
ggplot(my_data, aes(x=healthcare, y=economist)) + 
  geom_bin2d() +
  scale_x_discrete(labels=labels) +
  scale_y_discrete(labels=labels) +
  xlab("health") + ylab("economics") + 
  ggtitle("2D histogram") +
  theme_bw()

ggplot(my_data, aes(x=scientist, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

ggplot(my_data, aes(x=healthcare, y=national_gov)) + 
  geom_bin2d() +
  scale_x_discrete(labels=labels) +
  scale_y_discrete(labels=labels) +  
  xlab("health") + ylab("goverment") + 
  ggtitle("2D histogram") +
  theme_bw()

ggplot(my_data, aes(x=self, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

ggplot(my_data[!is.na(as.numeric(as.character(my_data$local_gov))),], 
       aes(x=local_gov, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

ggplot(my_data, aes(x=national_gov, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

ggplot(my_data, aes(x=healthcare, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

ggplot(my_data, aes(x=economist, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

ggplot(my_data, aes(x=familyfriends, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("How Well-informed")

```

## How much reaction
```{r}
colnames(data.all)[207:212]
react <- data.all[, c(207:212, 391)]

colnames(react) <- c("national","state","scientist","healthcare","economist","self","is.young")

labels <- c("Completely overreacting", "Somewhat overreacting","Appropriate","Somewhat insufficient", "Completely insufficient")

ggplot(react, aes(x=national, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Reaction to pandemic")

ggplot(react[!is.na(as.numeric(as.character(react$state))),], aes(x=state, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Reaction to pandemic")

ggplot(react, aes(x=scientist, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels)  +
  rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Reaction to pandemic")

ggplot(react, aes(x=healthcare, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Reaction to pandemic")

ggplot(react, aes(x=economist, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Reaction to pandemic")

ggplot(react, aes(x=self, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Reaction to pandemic")

```

reaction and attitude
```{r}
ggplot(data.all[data.all$error.med<0.5,], aes(x=ambig1_react_nation, y=ambig_corr.med)) + 
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2),size=0.8, alpha = 0.3,color="red") +
  geom_boxplot(width=0.1) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("National government reaction") +
  scale_x_discrete(labels=labels) +
  ylab("Model-free Ambig Medical") +
  # theme_classic() +
  rotate_x_text(20)


ggplot(data.all[data.all$error.mon<0.5,], aes(x=ambig1_react_nation, y=ambig_corr.mon)) + 
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2),size=0.8, alpha=0.3,color="red") +
  geom_boxplot(width=0.1) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("National government reaction") +
  scale_x_discrete(labels=labels) +
  ylab("Model-free Ambig Monetary") +
  # theme_classic() +
  rotate_x_text(20)

ggplot(data.all[data.all$error.med<0.5,], aes(x=ambig1_react_nation, y=risk.med)) + 
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2),size=0.8, alpha = 0.3,color="red") +
  geom_boxplot(width=0.1) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("National government reaction") +
  scale_x_discrete(labels=labels) +
  ylab("Model-free Risk Medical") +
  # theme_classic() +
  rotate_x_text(20)


ggplot(data.all[data.all$error.mon<0.5,], aes(x=ambig1_react_nation, y=risk.mon)) + 
  geom_violin() +
  geom_jitter(shape=16, position=position_jitter(0.2),size=0.8, alpha=0.3,color="red") +
  geom_boxplot(width=0.1) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("National government reaction") +
  scale_x_discrete(labels=labels) +
  ylab("Model-free Risk Monetary") +
  # theme_classic() +
  rotate_x_text(20)
```

## Should consider health impact by state
```{r}
data.all$ambig2_health_impact <- as.numeric(as.character(data.all$ambig2_health_impact))

# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(health_impact=4-data.all$ambig2_health_impact),list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$health_impact[idx] <- mean(geo$health_impact[geo$state==state_all[idx]],na.rm=TRUE)
}

# plot
plot_usmap(data=geo_state, regions="states",values="health_impact") +
  scale_fill_gradient2(limits=c(-1,3),midpoint=0,low=muted("blue"),high=muted("red")) +
  ggtitle("Should consider health impact") +
  labs(fill = "Extremely (Red) \n~ \nUncertain (White) \n~ \nNot at all (Blue) \n") +
  theme(legend.position = "right")

```

## Should consider economic impact by state
```{r}

data.all$ambig2_economics <- as.numeric(as.character(data.all$ambig2_economics))

# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(economic_impact=4-data.all$ambig2_economics),list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)
# View(geo_state)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$economic_impact[idx] <- mean(geo$economic_impact[geo$state==state_all[idx]],na.rm=TRUE)
}

# plot
plot_usmap(data=geo_state, regions="states",values="economic_impact") +
  scale_fill_gradient2(limits=c(-1,3),midpoint=0,low=muted("blue"),high=muted("red")) +
  ggtitle("Should consider economic impact") +
  labs(fill = "Extremely (Red) \n~ \nUncertain (White) \n~ \nNot at all (Blue) \n") +
  theme(legend.position = "right")

```

## Health - economic impact
```{r}
data.all$ambig2_economics <- as.numeric(as.character(data.all$ambig2_economics))
data.all$ambig2_health_impact <- as.numeric(as.character(data.all$ambig2_health_impact))

# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(health_economic=data.all$ambig2_economics-data.all$ambig2_health_impact),list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)
# View(geo_state)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$health_economic[idx] <- mean(geo$health_economic[geo$state==state_all[idx]],na.rm=TRUE)
}

# plot
plot_usmap(data=geo_state, regions="states",values="health_economic") +
  scale_fill_gradient2(midpoint=0,low=muted("blue"),high=muted("red")) +
  ggtitle("Should consider impact: heath-economic contrast") +
  labs(fill = "Health (Red) \n~ \nUnbiased (White) \n~ \nEconomic (Blue) \n") +
  theme(legend.position = "right")

```

## How well-informed is the local government
```{r}

data.all$ambig1_gov_local <- as.numeric(as.character(data.all$ambig1_gov_local))

# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(informed=4-data.all$ambig1_gov_local),list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')
# View(data.zipcode)
# View(geo)

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$informed[idx] <- mean(geo$informed[geo$state==state_all[idx]],na.rm=TRUE)
}

# map the state data to us map
# geo_state_map <- map_with_data(geo_state, values="count", na=0)

# plot
plot_usmap(data=geo_state, regions="states",values="informed") +
  scale_fill_gradient2(midpoint=0,low=muted("blue"),high=muted("red")) +
  ggtitle("How well-informed is the local government") +
  labs(fill = "Very (Red) \n~ \nUncertain (White) \n~ \nVery not (Blue) \n") +
  # labs(fill = "Very not(-3) ~ Uncertain(0) ~ Very(3)") +
  theme(legend.position = "right")
```


## How appropriate is the local government reaction by state
```{r}

data.all$ambig1_react_state <- as.numeric(as.character(data.all$ambig1_react_state))

# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(react=data.all$ambig1_react_state-3),list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')
# View(data.zipcode)
# View(geo)

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$react[idx] <- mean(geo$react[geo$state==state_all[idx]],na.rm=TRUE)
}

# plot
plot_usmap(data=geo_state, regions="states",values="react") +
  scale_fill_gradient2(midpoint=0) +
  ggtitle("How appropriate is the state government's reaction") +
  labs(fill = "Insufficient(Blue) \n~\nAppropriate(White) \n~\nOverreacting(Red) \n") +
  theme(legend.position = "right")

```

# Anxiety level by state
```{r}
data.all$anx_feelingnow <- as.numeric(as.character(data.all$anx_feelingnow))

# location of county by zipcode
data.zipcode<-aggregate(
  data.frame(anx=data.all$anx_feelingnow)-4,list(zip=data.all$zipcode),
  mean,
  na.action=na.omit)

geo<- merge(data.zipcode, zipcode, by='zip')

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$anx[idx] <- mean(geo$anx[geo$state==state_all[idx]],na.rm=TRUE)
}

# plot
plot_usmap(data=geo_state, regions="states",values="anx") +
  scale_fill_gradient2(midpoint=0,low=muted("blue"),high=muted("red")) +
  ggtitle("How anxious are you feeling now") +
  labs(fill = "Extremely (Red)\n~\nA fair amount (White) \n~\nNot at all (Blue)\n") +
  theme(legend.position = "right")

```

# Count of participants by state
```{r}
# location of county by zipcode
data.zipcode<-aggregate(data.frame(count=data.all$mTurkCode),list(zip=data.all$zipcode),length)
geo<- merge(data.zipcode, zipcode, by='zip')
# View(data.zipcode)
# View(geo)

# location of state by zipcodes
state_all <- unique(geo$state)
geo_state <- data.frame(state = state_all)
View(geo_state)

state_match <- match(geo$state, state_all)
for (idx in 1:length(state_all)) {
  geo_state$count[idx] <- sum(geo$count[geo$state==state_all[idx]])
}

# map the state data to us map
# geo_state_map <- map_with_data(geo_state, values="count", na=0)

# plot
plot_usmap(data=geo_state, regions="states",values="count") +
  ggtitle("Count of participants") +
  labs(fill = "Count") +
  theme(legend.position = "right")
```

```{r}
#  library(maps)
us_map<-map_data('state')

library(sf)
us_states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))

# state abbreviation to full name
data("state.fips")
state.name <- state.fips[,-1:-4]
state.name$polyname[c(21,23,35,39,55,60)] <- c("massachusetts", "michigan","new york","north carolina","virginia","washington")
state.name <- state.name[c(-20,-22,-24,-34,-36,-37,-38,-40,-53,-54,-56:-59),]
state.name[nrow(state.name)+1,] <- c("HI", "hawaii")


geo$state_full <- as.factor(state.name$polyname[match(geo$state, state.name$abb)])

us_states$count <- sum(geo$count[match(geo$state_full == us_states$ID)])

ggplot(us_states) +
  geom_sf(aes(fill = as.factor(count))) +
  # geom_text(aes(long, lat, label = count), color = "white") +
  # geom_point(aes(color = count),size=0.8,alpha=0.4) + 
  # scale_colour_gradient(high="dark blue", low="light blue") +
  # scale_color_continuous(breaks = c(1,2), labels = c(1,2)) +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank()) +
  xlim(-125,-65)+ylim(20,50)
  

```

# Anxiety, distribution
```{r}
colnames(data.all)[309:317]

labels <- c("Not at all", "A little", "Somewhat", "A fair amount", "Much", "Very much", "Extremely")

ggplot(data.all, aes(x=anx_feelingnow, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  scale_x_discrete(labels=labels) +
  # rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  xlab("Anxiety level now") +
  ggtitle("Anxiety now")

ggplot(data.all, aes(x=anx_TVnewspaper, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  # scale_x_discrete(labels=labels) +
  # rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Anxiety TV Newspaper")

ggplot(data.all, aes(x=anx_socialmedia, fill = is.young)) +
  geom_histogram(stat="count", position="stack") +
  # scale_x_discrete(labels=labels) +
  # rotate_x_text(30) +
  scale_fill_discrete(labels=c("Older", "Younger"), name="") +
  ggtitle("Anxiety social media")
```


Anxiety, violin plot
```{r}
labels <- c("Not at all", "A little", "Somewhat", "A fair amount", "Much", "Very much", "Extremely")

ggplot(data.all[data.all$error.med<0.5,], aes(x=anx_feelingnow, y=ambig_corr.med)) + 
  geom_point() +
  ylab("model-free ambig Medical")

ggplot(data.all[data.all$error.med<0.5,], aes(x=anx_feelingnow, y=ambig_corr.med)) + 
  geom_violin() +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("Anxiety level now") +
  scale_x_discrete(labels=labels) +
  geom_jitter(shape=16, position=position_jitter(0.2),size=1,alpha=0.3,color="red") +
  geom_boxplot(width=0.1) +
  ylab("model-free ambig Medical")

ggplot(data.all[data.all$error.mon<0.5,], aes(x=anx_feelingnow, y=ambig_corr.mon)) + 
  geom_violin() +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("Anxiety level now") +
  scale_x_discrete(labels=labels) +
  geom_jitter(shape=16, position=position_jitter(0.2),size=1,alpha=0.3,color="red") +
  geom_boxplot(width=0.1) +
  ylab("model-free ambig Monetary")

ggplot(data.all[data.all$error.med<0.5,], aes(x=anx_feelingnow, y=risk.med)) + 
  geom_violin() +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("Anxiety level now") +
  scale_x_discrete(labels=labels) +
  geom_jitter(shape=16, position=position_jitter(0.2),size=1,alpha=0.3,color="red") +
  geom_boxplot(width=0.1) +
  ylab("model-free risk Medical")

ggplot(data.all[data.all$error.mon<0.5,], aes(x=anx_feelingnow, y=risk.mon)) + 
  geom_violin() +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3) +
  xlab("Anxiety level now") +
  scale_x_discrete(labels=labels) +
  geom_jitter(shape=16, position=position_jitter(0.2),size=1,alpha=0.3,color="red") +
  geom_boxplot(width=0.1) +
  ylab("model-free risk Monetary")
```


# risk exposure block
```{r}
data.all$Q1027
# those who themselves were infected with COVID-19
data.all$mTurkCode[data.all$Q1027 == 1]
# 2-immediate family, 3 - extended family, 9 - no
```

action block
```{r}

```


