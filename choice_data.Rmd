---
title: "R Notebook"
author: "ruonanjia"
---

```{r}
rm(list = ls())
```


load library
```{r}
library(ggplot2)
library(ggpubr)
library(viridis)
```


functions
```{r}
data_summary <- function(data, varname, groupnames){
  # Function to calculate the mean and the standard error
  # for each group
  #+++++++++++++++++++++++++
  # data : a data frame
  # varname : the name of a column containing the variable
  #to be summariezed
  # groupnames : vector of column names to be used as
  # grouping variables
  
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE)/sqrt(length(x[[col]])))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}


data_meanstd <- function(x) {
  # Function to produce summary statistics (mean and +/- sd)
  m <- mean(x)
  ymin <- m-sd(x)
  ymax <- m+sd(x)
  return(c(y=m,ymin=ymin,ymax=ymax))
}

data_meanse <- function(x) {
  # Function to produce summary statistics (mean and +/- sd)
  m <- mean(x)
  ymin <- m-sd(x)/sqrt(length(x))
  ymax <- m+sd(x)/sqrt(length(x))
  return(c(y=m,ymin=ymin,ymax=ymax))
}

```


load data
```{r}
# setwd("E:/Ruonan/Projects in the lab/mdm_covid19/batch_data")
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
load("data_all_444sub_rename.Rda")
load("data_all_444sub_rename_header.Rda")
load("data_all_444sub_attitude.Rda")

# combine data
data.all <- merge(data.all, data.attitude, by = "mTurkCode")
data.all$age <- as.numeric(as.character(data.all$age)) + 17 # correct coding

trial.param <- read.csv("trialsinfo_COVID_19.csv", header = TRUE, )
```

exclude subjects with too many stochastic dominance
```{r}
exclude_list <- data.frame(id = as.character(data.all$mTurkCode[data.all$error.mon >= 0.5]))
exclude_list
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
write.csv(exclude_list, file="exclude_list_mon.csv",row.names = FALSE)
```

```{r}
colnames(data.all)
```


estimation of ambiguity
```{r}
data.all$AmbigE_posoutcome_38 <- as.numeric(as.character(data.all$AmbigE_posoutcome_38))
data.all$AmbigE_posoutcome_25 <- as.numeric(as.character(data.all$AmbigE_posoutcome_25))
data.all$AmbigE_posoutcome_13 <- as.numeric(as.character(data.all$AmbigE_posoutcome_13))
data.all$AmbigE_posoutcome_na <- as.numeric(as.character(data.all$AmbigE_posoutcome_na))

data.all$RMon_1 <- as.factor(as.character(data.all$RMon_1))
data.all$RMon_2 <- as.factor(as.character(data.all$RMon_2))
data.all$RMon_3 <- as.factor(as.character(data.all$RMon_3))
data.all$RMon_4 <- as.factor(as.character(data.all$RMon_4))
data.all$RMon_5 <- as.factor(as.character(data.all$RMon_5))

data.all$RMedn_1 <- as.factor(as.character(data.all$RMed_1))
data.all$RMedn_2 <- as.factor(as.character(data.all$RMed_2))
data.all$RMedn_3 <- as.factor(as.character(data.all$RMed_3))
data.all$RMedn_4 <- as.factor(as.character(data.all$RMed_4))
data.all$RMedn_5 <- as.factor(as.character(data.all$RMed_5))

```

organize ambiguity estimation
```{r}
mask <- data.all$error.med < 0.5 & data.all$error.mon < 0.5

sum(mask)

ambig.level <- as.factor(c(rep(24, nrow(data.all[mask,])), rep(50, nrow(data.all[mask,])), rep(74, nrow(data.all[mask,])), rep(100, nrow(data.all[mask,]))))

estimate <- c(data.all$AmbigE_posoutcome_38[mask], data.all$AmbigE_posoutcome_25[mask], data.all$AmbigE_posoutcome_13[mask], data.all$AmbigE_posoutcome_na[mask])

mTurkCode <- as.factor(rep(data.all$mTurkCode[mask] ,4))

age <- rep(data.all$age[mask] ,4)

ambig.estimate <- data.frame(ambig.level, estimate, age, mTurkCode)
```

```{r}
ambig.estimate$is.young <- 1
ambig.estimate$is.young[ambig.estimate$age>60] <- 0
ambig.estimate$is.young <- as.factor(ambig.estimate$is.young)

sum(ambig.estimate$is.young == 0)/4
sum(ambig.estimate$is.young == 1)/4

length(unique(ambig.estimate$mTurkCode))
length(ambig.estimate$mTurkCode)
```


plot ambiguity estimation
```{r}
data2plot <- data_summary(ambig.estimate, "estimate", "ambig.level")

ggplot(data2plot, aes(x=ambig.level, y=estimate)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=estimate-sd, ymax=estimate+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Estimation of outcome probability")

ggplot(ambig.estimate, aes(x=ambig.level, y=estimate)) + 
  geom_violin(trim=TRUE) +
  # geom_boxplot(width=0.05) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.5) +
  # geom_jitter(shape=16, position=position_jitter(0.2)) +
  ggtitle("Estimation of outcome probability")

data2plot <- data_summary(ambig.estimate, "estimate", c("ambig.level", "is.young"))

ggplot(data2plot, aes(x=ambig.level, y=estimate, color=is.young, fill = is.young)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=estimate-sd, ymax=estimate+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Estimation of outcome probability separating age")

ggplot(ambig.estimate, aes(x=ambig.level, y=estimate, color=is.young, fill=is.young)) + 
  geom_violin(trim=TRUE) +
  # geom_boxplot(width=0.05) +
  # geom_dotplot(binaxis='y', stackdir='center', dotsize=0.5) +
  # geom_jitter(shape=16, position=position_jitter(0.2)) +
  ggtitle("Estimation of outcome probability separating age")
```

Look at age difference by anova
```{r}
library(ez)

anova_result <- ezANOVA(
    ambig.estimate[!is.na(ambig.estimate$estimate), ],
    dv = estimate,
    wid = mTurkCode,
    within = ambig.level,
    between = is.young,
    type = 3,
    return_aov = TRUE
)

anova_result

# linear mode
library(lme4)

lmer(estimate ~ age + 1|mTurkCode,
     data=ambig.estimate,
     na.action = na.omit
     )
```

## outcome rating
organize outcome rating
```{r}
mask <- data.all$error.med < 0.5 & data.all$error.mon < 0.5

sum(mask)

outcome.level <- as.factor(c(rep(0, nrow(data.all[mask,])), rep(1, nrow(data.all[mask,])), rep(2, nrow(data.all[mask,])), rep(3, nrow(data.all[mask,])), rep(4, nrow(data.all[mask,])), rep(0, nrow(data.all[mask,])), rep(1, nrow(data.all[mask,])), rep(2, nrow(data.all[mask,])), rep(3, nrow(data.all[mask,])), rep(4, nrow(data.all[mask,]))))

is.med <- as.factor(c(rep(0, nrow(data.all[mask,])*5), rep(1, nrow(data.all[mask,])*5)))

rating <- c(as.numeric(as.character(data.all$RMon_1[mask])), 
            as.numeric(as.character(data.all$RMon_2[mask])), 
            as.numeric(as.character(data.all$RMon_3[mask])), 
            as.numeric(as.character(data.all$RMon_4[mask])), 
            as.numeric(as.character(data.all$RMon_5[mask])), 
            as.numeric(as.character(data.all$RMed_1[mask])), 
            as.numeric(as.character(data.all$RMed_2[mask])), 
            as.numeric(as.character(data.all$RMed_3[mask])), 
            as.numeric(as.character(data.all$RMed_4[mask])), 
            as.numeric(as.character(data.all$RMed_5[mask]))
)

mTurkCode <- rep(data.all$mTurkCode[mask] ,10)

outcome.rating <- data.frame(is.med, outcome.level, rating, mTurkCode)
```

plot rating
```{r}
data2plot <- data_summary(outcome.rating[outcome.rating$is.med == 0,], "rating", "outcome.level")

ggplot(data2plot, aes(x=outcome.level, y=rating)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=rating-sd, ymax=rating+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Rating of outcome, Monetary")

data2plot <- data_summary(outcome.rating[outcome.rating$is.med == 1,], "rating", "outcome.level")

ggplot(data2plot, aes(x=outcome.level, y=rating)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=rating-sd, ymax=rating+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Rating of outcome, Medical")
```


violin plot rating
```{r}
data2plot <- data_summary(outcome.rating[outcome.rating$is.med == 0,], "rating", "outcome.level")

ggplot(outcome.rating[outcome.rating$is.med == 0,], aes(x=outcome.level, y=rating)) + 
  geom_violin() +
  ggtitle("Rating of outcome, Monetary")

ggplot(outcome.rating[outcome.rating$is.med == 1,], aes(x=outcome.level, y=rating)) + 
  geom_violin() +
  ggtitle("Rating of outcome, Medical")
```


individual subjects rating
```{r}
alpha_value <- 0.2

length(unique(outcome.rating$mTurkCode))

ggplot(outcome.rating[outcome.rating$is.med == 0,], aes(x = as.numeric(outcome.level), y = rating, color = mTurkCode)) +
  geom_point(size = 2) + geom_line(size = 1, alpha = alpha_value) +
  scale_color_viridis(discrete = TRUE, option = "A") +
  theme(panel.background = element_rect(fill = "grey80")) +
  ggtitle('Rating, Monetary') +
  theme(legend.position = "none")
```

task data
```{r}
# colnames(data.all)
colnames(data.all)[c(30:42,44:55,57:80,90:102,104:114,116:140,141:150,152:155,1)]

# choice, rating, and ambiguity estimation
data.task <- data.all[,c(30:42,44:55,57:80,90:102,104:114,116:140,141:150,152:155,1)]
# View(data.task)
# colnames(data.task)
# change column names for ambiguity estimation
# colnames(data.task)[109:112] <- c("a24.e", "a50.e", "a74.e", "a100.e")
# colnames(data.task)

```

extract choice data
```{r}
# extract choice data and attache trial parameters
# concatenate all subjects

# colnames(trial.param)
# colnames(data.task)

for (i in 1:nrow(data.task)) {
  # single subject choice
  sub.choice <- trial.param
  choice <- data.task[i, 1:98]
  id <- as.factor(as.character(data.task$mTurkCode[i])) # MTurk code
  sub.choice$id <- id
  sub.choice$choice <- as.numeric(t(choice)) # transpose
  
  # concatenate
  if (i == 1) {
    data.choice <- sub.choice
  } else {
    data.choice <- rbind(data.choice, sub.choice)
  }
}

# View(data.choice)

# typeof(data.choice$val)

data.choice.mon <- data.choice[data.choice$is_med == 0, ]
data.choice.med <- data.choice[data.choice$is_med == 1, ]


data.choice.mon$val <- as.numeric(as.character(data.choice.mon$val))
data.choice.mon$prob <- as.factor(data.choice.mon$prob)
data.choice.mon$ambig <- as.factor(data.choice.mon$ambig)

data.choice.med$val <- as.factor(data.choice.med$val)
data.choice.med$prob <- as.factor(data.choice.med$prob)
data.choice.med$ambig <- as.factor(data.choice.med$ambig)
```

save data
```{r}
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
save(data.choice.mon, file="data_choice_mon_444sub.Rda")
save(data.choice.med, file="data_choice_med_444sub.Rda")

```


Plot average choice probability by uncertainty level
```{r}
# # monetary
# ggplot(data.choice.mon[data.choice.mon$id == id & data.choice.mon$ambig == 0, ], aes(x = val, y = choice, color = prob, fill = prob)) + 
#   geom_point(stat = "identity", size = 2, alpha = 0.6) +
#   geom_line()
# 
# ggplot(data.choice.mon[data.choice.mon$id == id & data.choice.mon$ambig != 0, ], aes(x = val, y = choice, color = ambig, fill = ambig)) + 
#   geom_point(stat = "identity", size = 2, alpha = 0.6) +
#   geom_line()
# 
# # medical
# ggplot(data.choice.med[data.choice.med$id == id & data.choice.med$ambig == 0, ], aes(x = val, y = choice, color = prob, fill = prob)) + 
#   geom_point(stat = "identity", size = 2, alpha = 0.6) +
#   scale_x_discrete(limits = c("Slight", "Moderate", "Major", "Recovery")) +
#   geom_line()

# typeof(data.choice.med$prob)

# monetary risky
data_plot <- data_summary(data.choice.mon[data.choice.mon$ambig == 0,], varname = "choice", groupnames = "prob")

ggplot(data_plot, aes(x=prob, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Monetary Risky")

# monetary ambiguous
data_plot <- data_summary(data.choice.mon[data.choice.mon$ambig != 0,], varname = "choice", groupnames = "ambig")

ggplot(data_plot, aes(x=ambig, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Monetary Ambiguous")

# medical risky
data_plot <- data_summary(data.choice.med[data.choice.med$ambig == 0,], varname = "choice", groupnames = "prob")

ggplot(data_plot, aes(x=prob, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Medical Risky")

# medical ambiguous
data_plot <- data_summary(data.choice.med[data.choice.med$ambig != 0,], varname = "choice", groupnames = "ambig")

ggplot(data_plot, aes(x=ambig, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Medical Ambiguous")


```

plot average choice probability by value
```{r}
# monetary risky
data_plot <- data_summary(data.choice.mon[data.choice.mon$ambig == 0,], varname = "choice", groupnames = "val")

ggplot(data_plot, aes(x=val, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  scale_x_discrete(limits = c(5,8,12,25)) +
  ggtitle("Monetary Risky")

# monetary ambiguous
data_plot <- data_summary(data.choice.mon[data.choice.mon$ambig != 0,], varname = "choice", groupnames = "val")

ggplot(data_plot, aes(x=val, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  scale_x_discrete(limits = c(5,8,12,25)) +
  ggtitle("Monetary Ambiguous")

# medical risky
data_plot <- data_summary(data.choice.med[data.choice.med$ambig == 0,], varname = "choice", groupnames = "val")

ggplot(data_plot, aes(x=val, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  scale_x_discrete(limits = c("Slight", "Moderate", "Major", "Recovery")) +
  ggtitle("Medical Risky")

# medical ambiguous
data_plot <- data_summary(data.choice.med[data.choice.med$ambig != 0,], varname = "choice", groupnames = "val")

ggplot(data_plot, aes(x=val, y=choice)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice-sd, ymax=choice+sd), width=0.2, position=position_dodge(0.9)) +
  scale_x_discrete(limits = c("Slight", "Moderate", "Major", "Recovery")) +
  ggtitle("Medical Ambiguous")
```


individual subject choice data model free attitude
```{r}
# id_idx = 1
ids <- data.task$mTurkCode

risk.mon <- rep(0,length(ids))
ambig_corr.mon <- rep(0,length(ids))
risk.med <- rep(0,length(ids))
ambig_corr.med <- rep(0,length(ids))

error.mon <- rep(0,length(ids))
error.med <- rep(0,length(ids))

# ismed <- array(numeric())
# choice_uncert <- array(numeric())
# choice_outcome <- array(numeric())
# prob <- array(numeric())
# ambig <- array(numeric())
# val <- array(numeric())

risk25.mon <- rep(0,length(ids))
risk50.mon <- rep(0,length(ids))
risk75.mon <- rep(0,length(ids))
ambig24.mon <- rep(0,length(ids))
ambig50.mon <- rep(0,length(ids))
ambig74.mon <- rep(0,length(ids))
ambig100.mon <- rep(0,length(ids))

risk25.med <- rep(0,length(ids))
risk50.med <- rep(0,length(ids))
risk75.med <- rep(0,length(ids))
ambig24.med <- rep(0,length(ids))
ambig50.med <- rep(0,length(ids))
ambig74.med <- rep(0,length(ids))
ambig100.med <- rep(0,length(ids))

level1.risk.mon <- rep(0,length(ids))
level2.risk.mon <- rep(0,length(ids))
level3.risk.mon <- rep(0,length(ids))
level4.risk.mon <- rep(0,length(ids))
level1.ambig.mon <- rep(0,length(ids))
level2.ambig.mon <- rep(0,length(ids))
level3.ambig.mon <- rep(0,length(ids))
level4.ambig.mon <- rep(0,length(ids))

level1.risk.med <- rep(0,length(ids))
level2.risk.med <- rep(0,length(ids))
level3.risk.med <- rep(0,length(ids))
level4.risk.med <- rep(0,length(ids))
level1.ambig.med <- rep(0,length(ids))
level2.ambig.med <- rep(0,length(ids))
level3.ambig.med <- rep(0,length(ids))
level4.ambig.med <- rep(0,length(ids))

idx = 0

for (id in ids) {
  idx <- idx + 1
  
  # single subject data
  sub.mon <- data.choice.mon[data.choice.mon$id == id,]
  sub.med <- data.choice.med[data.choice.med$id == id,]
  sub.mon$val <- as.factor(sub.mon$val)
  
  # stochastic dominance error
  error.mon[idx] = mean(sub.mon$choice[sub.mon$val==5])
  error.med[idx] = mean(sub.med$choice[sub.med$val=="Slight"])
  
  # choice by uncertainty level
  # summary_risk_mon = data_summary(sub.mon[sub.mon$val!=5 & sub.mon$ambig==0,], "choice", "prob")
  # summary_ambig_mon = data_summary(sub.mon[sub.mon$val!=5 & sub.mon$ambig!=0,], "choice", "ambig")
  # summary_risk_med = data_summary(sub.med[sub.med$val!="Slight" & sub.med$ambig==0,], "choice", "prob")
  # summary_ambig_med = data_summary(sub.med[sub.med$val!="Slight" & sub.med$ambig!=0,], "choice", "ambig")
  # 
  # ismed <- append(ismed, c(summary_risk_mon))
  # prob <- append(prob, c())
  
  risk25.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.25])
  risk50.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.5])
  risk75.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.75])

  risk25.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.25])
  risk50.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.5])
  risk75.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.75])

  ambig24.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0.24]) -
    mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.5])
  ambig50.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0.50]) -
    mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.5])
  ambig74.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0.75]) -
    mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.5])
  ambig100.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==1]) -
    mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.5])

  ambig24.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0.24]) -
    mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.5])
  ambig50.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0.50]) -
    mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.5])
  ambig74.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0.75]) -
    mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.5])
  ambig100.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==1]) -
    mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.5])
  
  # choice by outcome level
  # summary_val_risk_mon = data_summary(sub.mon[sub.mon$ambig==0,], "choice", "val")
  # summary_val_ambig_mon = data_summary(sub.mon[sub.mon$ambig!=0,], "choice", "val")
  # summary_val_risk_med = data_summary(sub.med[sub.med$ambig==0,], "choice", "val")
  # summary_val_ambig_med = data_summary(sub.med[sub.med$ambig!=0,], "choice", "val")
  
  
  level1.risk.mon[idx] = mean(sub.mon$choice[sub.mon$val==5 & sub.mon$ambig==0])
  level2.risk.mon[idx] = mean(sub.mon$choice[sub.mon$val==8 & sub.mon$ambig==0])
  level3.risk.mon[idx] = mean(sub.mon$choice[sub.mon$val==12 & sub.mon$ambig==0])
  level4.risk.mon[idx] = mean(sub.mon$choice[sub.mon$val==25 & sub.mon$ambig==0])

  level1.ambig.mon[idx] = mean(sub.mon$choice[sub.mon$val==5 & sub.mon$ambig!=0])
  level2.ambig.mon[idx] = mean(sub.mon$choice[sub.mon$val==8 & sub.mon$ambig!=0])
  level3.ambig.mon[idx] = mean(sub.mon$choice[sub.mon$val==12 & sub.mon$ambig!=0])
  level4.ambig.mon[idx] = mean(sub.mon$choice[sub.mon$val==25 & sub.mon$ambig!=0])

  level1.risk.med[idx] = mean(sub.med$choice[sub.med$val=="Slight" & sub.med$ambig==0])
  level2.risk.med[idx] = mean(sub.med$choice[sub.med$val=="Moderate" & sub.med$ambig==0])
  level3.risk.med[idx] = mean(sub.med$choice[sub.med$val=="Major" & sub.med$ambig==0])
  level4.risk.med[idx] = mean(sub.med$choice[sub.med$val=="Recovery" & sub.med$ambig==0])

  level1.ambig.med[idx] = mean(sub.med$choice[sub.med$val=="Slight" & sub.med$ambig!=0])
  level2.ambig.med[idx] = mean(sub.med$choice[sub.med$val=="Moderate" & sub.med$ambig!=0])
  level3.ambig.med[idx] = mean(sub.med$choice[sub.med$val=="Major" & sub.med$ambig!=0])
  level4.ambig.med[idx] = mean(sub.med$choice[sub.med$val=="Recovery" & sub.med$ambig!=0])

  # model-free attitude
  risk.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0])
  ambig_corr.mon[idx] = mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig!=0])-
    mean(sub.mon$choice[sub.mon$val!=5 & sub.mon$ambig==0 & sub.mon$prob==0.5])
  
  risk.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0])
  ambig_corr.med[idx] = mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig!=0])-
    mean(sub.med$choice[sub.med$val!="Slight" & sub.med$ambig==0 & sub.med$prob==0.5])
  
}  

data.attitude <- data.frame(mTurkCode = ids,
                            risk.mon, ambig_corr.mon, risk.med, ambig_corr.med,
                            risk25.mon, risk50.mon, risk75.mon,
                            ambig24.mon, ambig50.mon, ambig74.mon, ambig100.mon,
                            risk25.med, risk50.med, risk75.med,
                            ambig24.med, ambig50.med, ambig74.med, ambig100.med,
                            level1.risk.mon, level2.risk.mon, level3.risk.mon, level4.risk.mon,
                            level1.ambig.mon, level2.ambig.mon, level3.ambig.mon, level4.ambig.mon,
                            level1.risk.med, level2.risk.med, level3.risk.med, level4.risk.med,
                            level1.ambig.med, level2.ambig.med, level3.ambig.med, level4.ambig.med,
                            error.mon, error.med)

```

save model free attitude
```{r}
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
save(data.attitude, file="data_all_444sub_attitude.Rda")
```

plot average of choice by uncertainty level
```{r}

# monetary risk
data2plot <- data.frame(
   prob.level = as.factor(c(0.25, 0.5, 0.75)),
   choice.mean = c(mean(data.attitude$risk25.mon[data.attitude$error.mon<0.5]),
                       mean(data.attitude$risk50.mon[data.attitude$error.mon<0.5]),
                       mean(data.attitude$risk75.mon[data.attitude$error.mon<0.5])),
   choice.se = c(sd(data.attitude$risk25.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$risk25.mon[data.attitude$error.mon<0.5])),
                  sd(data.attitude$risk50.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$risk50.mon[data.attitude$error.mon<0.5])),
                  sd(data.attitude$risk75.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$risk75.mon[data.attitude$error.mon<0.5])))
)

ggplot(data2plot, aes(x = prob.level, y = choice.mean)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice.mean-choice.se, ymax=choice.mean+choice.se), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Monetary Risky Trials")

# medical risk
data2plot <- data.frame(
   prob.level = as.factor(c(0.25, 0.5, 0.75)),
   choice.mean = c(mean(data.attitude$risk25.med[data.attitude$error.med<0.5]),
                       mean(data.attitude$risk50.med[data.attitude$error.med<0.5]),
                       mean(data.attitude$risk75.med[data.attitude$error.med<0.5])),
   choice.se = c(sd(data.attitude$risk25.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$risk25.med[data.attitude$error.med<0.5])),
                  sd(data.attitude$risk50.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$risk50.med[data.attitude$error.med<0.5])),
                  sd(data.attitude$risk75.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$risk75.med[data.attitude$error.med<0.5])))
)

ggplot(data2plot, aes(x = prob.level, y = choice.mean)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice.mean-choice.se, ymax=choice.mean+choice.se), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Medical Risky Trials")

# monetary ambiguity
data2plot <- data.frame(
   ambig.level = as.factor(c(0.24, 0.50, 0.74, 1)),
   choice.mean = c(mean(data.attitude$ambig24.mon[data.attitude$error.mon<0.5]),
                    mean(data.attitude$ambig50.mon[data.attitude$error.mon<0.5]),
                    mean(data.attitude$ambig74.mon[data.attitude$error.mon<0.5]),
                    mean(data.attitude$ambig100.mon[data.attitude$error.mon<0.5])),
   choice.se = c(sd(data.attitude$ambig24.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$ambig24.mon[data.attitude$error.mon<0.5])),
                  sd(data.attitude$ambig50.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$ambig50.mon[data.attitude$error.mon<0.5])),
                  sd(data.attitude$ambig74.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$ambig74.mon[data.attitude$error.mon<0.5])),
                  sd(data.attitude$ambig100.mon[data.attitude$error.mon<0.5])/sqrt(length(data.attitude$ambig100.mon[data.attitude$error.mon<0.5])))
)

ggplot(data2plot, aes(x = ambig.level, y = choice.mean)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice.mean-choice.se, ymax=choice.mean+choice.se), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Monetary Ambiguous Trials, risk50 corrected")

# Medical ambiguity
data2plot <- data.frame(
   ambig.level = as.factor(c(0.24, 0.50, 0.74, 1)),
   choice.mean = c(mean(data.attitude$ambig24.med[data.attitude$error.med<0.5]),
                    mean(data.attitude$ambig50.med[data.attitude$error.med<0.5]),
                    mean(data.attitude$ambig74.med[data.attitude$error.med<0.5]),
                    mean(data.attitude$ambig100.med[data.attitude$error.med<0.5])),
   choice.se = c(sd(data.attitude$ambig24.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$ambig24.med[data.attitude$error.med<0.5])),
                  sd(data.attitude$ambig50.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$ambig50.med[data.attitude$error.med<0.5])),
                  sd(data.attitude$ambig74.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$ambig74.med[data.attitude$error.med<0.5])),
                  sd(data.attitude$ambig100.med[data.attitude$error.med<0.5])/sqrt(length(data.attitude$ambig100.med[data.attitude$error.med<0.5])))
)

ggplot(data2plot, aes(x = ambig.level, y = choice.mean)) +
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=choice.mean-choice.se, ymax=choice.mean+choice.se), width=0.2, position=position_dodge(0.9)) +
  ggtitle("Medical Ambiguous Trials, risk50 corrected")


```



plot individual subject choice data
```{r}
# id_idx = 1
ids <- data.task$mTurkCode

for (id in ids) {
  
  # single subject data
  sub.mon <- data.choice.mon[data.choice.mon$id == id,]
  sub.med <- data.choice.med[data.choice.med$id == id,]
  sub.mon$val <- as.factor(sub.mon$val)
  
  # monetary risky
  data_plot <- data_summary(sub.mon[sub.mon$ambig == 0,], varname = "choice", groupnames = c("val", "prob"))
  
  p1 <- ggplot(data_plot, aes(x=val, y=prob, fill=choice)) + 
    geom_tile(color = "white")+
    scale_x_discrete(breaks = c(5,8,12,25)) +
    scale_fill_gradient(limits = c(0,1)) +
    theme(panel.grid = element_blank(),
          panel.background = element_blank()) +
    ggtitle(paste("Monetary Risky, Sub", as.character(id))) +
    xlab("Value ($)") + ylab("Risk Level")
  
  # monetary ambiguous
  data_plot <- data_summary(sub.mon[sub.mon$ambig != 0,], varname = "choice", groupnames = c("val", "ambig"))
  
  p2 <- ggplot(data_plot, aes(x=val, y=ambig, fill=choice)) + 
    geom_tile(color = "white")+
    scale_x_discrete(breaks = c(5,8,12,25)) +
    scale_fill_gradient(limits = c(0,1)) +
    theme(panel.grid = element_blank(),
          panel.background = element_blank()) +
    ggtitle("Monetary Ambiguous") +
    xlab("Value ($)") + ylab("Ambiguity Level")
  
  # medical risky
  data_plot <- data_summary(sub.med[sub.med$ambig == 0,], varname = "choice", groupnames = c("val", "prob"))
  
  p3 <- ggplot(data_plot, aes(x=val, y=prob, fill=choice)) + 
    geom_tile(color = "white")+
    scale_x_discrete(limits = c("Slight", "Moderate", "Major", "Recovery")) +
    scale_fill_gradient(limits = c(0,1)) +
    theme(panel.grid = element_blank(),
          panel.background = element_blank()) +
    ggtitle("Medical Risky") +
    xlab("Outcome") + ylab("Risk Level")
  
  # medical ambiguous
  data_plot <- data_summary(sub.med[sub.med$ambig != 0,], varname = "choice", groupnames = c("val", "ambig"))
  
  p4 <- ggplot(data_plot, aes(x=val, y=ambig, fill=choice)) + 
    geom_tile(color = "white")+
    scale_x_discrete(limits = c("Slight", "Moderate", "Major", "Recovery")) +
    scale_fill_gradient(limits = c(0,1)) +
    theme(panel.grid = element_blank(),
          panel.background = element_blank()) +
    ggtitle("Medical Ambiguous") +
    xlab("Outcome") + ylab("Ambiguity Level")
  
  figure <- ggarrange(p1,p2,p3,p4,
                      ncol = 2, nrow = 2) + border(size = 2)

  print(figure)
  
  annotate_figure(figure,
                  top = text_grob(paste("MTurkCode", as.character(id)))
                  )

}
```


```{r}
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
write.csv(data.choice.mon,"data_choice_mon_444sub.csv", row.names = FALSE)
write.csv(data.choice.med,"data_choice_med_444sub.csv", row.names = FALSE)
```

# Bayesian fitting
Try model fitting by bayesian
```{r}
# install.packages(c("devtools","mvtnorm","loo","coda", "dagitty"))
# install.packages("backports")
# library(devtools)
# devtools::install_github("rmcelreath/rethinking")

library(rethinking)
```


## load data
### MDM covid19 data
```{r}
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")
path = "/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data"
load("data_choice_mon_444sub.Rda")
# load("data_choice_med_444sub.Rda")
```

exclude subjects
```{r}
setwd(path)
# those who did not choose any ambiguous lottery
exclude_list <- read.csv("exclude_bayesian_fitting_mon.csv", header = TRUE)
```


```{r}
# exclude_list
# colnames(data.choice.mon)
# data.choice.mon$id
# typeof(data.choice.mon$id)
# typeof(exclude_list$x)

# no. of subjects excluded
sum(is.element(data.choice.mon$id, exclude_list$x))/49 # 207

# exclude
data.choice.mon <- data.choice.mon[!is.element(data.choice.mon$id, exclude_list$x),]
nrow(data.choice.mon)/49 # 237 subjects left
```

### MDM imaging data
```{r}
setwd("/Users/jiaruonan/Desktop/mdm_covid19/mdm_covid19_data")

# no response trials are already excluded in this sheet
data <- read.csv("mdm_trialwise_08252020.csv", header = TRUE)
data <- data[data$is_med == 0,]

colnames(data)

log <- read.csv("log_11082019.csv", header=TRUE)
```

Exclude too many stochastic dominance error
```{r}
exclude <- log$id[log$is_exclude_behavior==1]
length(exclude)

data <- data[!is.element(data$id, exclude),]

data
```


## Prepare data for fitting
### MDM covid 19 data
```{r}
data.choice.mon$val <- data.choice.mon$val * 100

data.choice.mon$prob.ref <- 1 * rep(1, length(data.choice.mon$prob))
data.choice.mon$ambig.ref <- 0 * rep(1, length(data.choice.mon$prob))
data.choice.mon$val.ref <- 500 * rep(1, length(data.choice.mon$prob))

data.choice.mon$ambig <- as.numeric(as.character(data.choice.mon$ambig))
data.choice.mon$prob <- as.numeric(as.character(data.choice.mon$prob))

# check data type
typeof(data.choice.mon$prob)
typeof(data.choice.mon$ambig)
typeof(data.choice.mon$val)
typeof(data.choice.mon$prob.ref)
typeof(data.choice.mon$ambig.ref)
typeof(data.choice.mon$val.ref)

# make id: 1 ~ number of subjects
no_trials = sum(data.choice.mon$id == data.choice.mon$id[1])
no_trials

data.choice.mon$subid = NaN

for (i in c(1:(nrow(data.choice.mon)/no_trials))) {
  data.choice.mon$subid[(1+no_trials*(i-1)):(no_trials*i)] <- t(rep(i, no_trials))
}

data.choice.mon$subid <-  as.integer(as.character(data.choice.mon$subid))


# data_list <- list(
#   choice = as.numeric(as.character(data.choice.mon$choice)),
#   prob = as.numeric(as.character(data.choice.mon$prob)),
#   ambig = as.numeric(as.character(data.choice.mon$ambig)),
#   val = as.numeric(as.character(data.choice.mon$val)),
#   prob_ref = as.numeric(as.character(data.choice.mon$prob.ref)),
#   ambig_ref = as.numeric(as.character(data.choice.mon$ambig.ref)),
#   val_ref = as.numeric(as.character(data.choice.mon$val.ref)),
#   id = as.integer(data.choice.mon$subid)
# )


```

all subjects
```{r}
n_try = nrow(data.choice.mon)/no_trials
data_list <- list(
  choice = data.choice.mon$choice,
  prob = data.choice.mon$prob,
  ambig = data.choice.mon$ambig,
  val = data.choice.mon$val,
  prob_ref = data.choice.mon$prob.ref,
  ambig_ref = data.choice.mon$ambig.ref,
  val_ref = data.choice.mon$val.ref,
  id = data.choice.mon$subid
)
```

select subjects
```{r}
n_try = 12#  number of subjects to try
start = 1# start from the nth participant
data_list <- list(
  choice = data.choice.mon$choice[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  prob = data.choice.mon$prob[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  ambig = data.choice.mon$ambig[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  val = data.choice.mon$val[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  prob_ref = data.choice.mon$prob.ref[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  ambig_ref = data.choice.mon$ambig.ref[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  val_ref = data.choice.mon$val.ref[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)],
  id = data.choice.mon$subid[(no_trials*(start-1) + 1):((start + n_try-1)*no_trials)] - start + 1
)

```

check data
```{r}
data.choice.mon
View(data_list)
data_list[["id"]]
```

### MDM imaing data
make ids starting from 1
```{r}
id_unique <- unique(data$id)
id_unique
length(id_unique)
data$subid <- NaN
data$subid <- match(data$id, id_unique)

View(data)

typeof(data$subid)
```

```{r}
# check data type
typeof(data$prob)
typeof(data$ambig)
typeof(data$val)
typeof(data$prob_fix)
typeof(data$ambig_fix)
typeof(data$val_fix)
```

```{r}
data$val <- as.double(data$val)
data$prob_fix <- as.double(data$prob_fix)
data$ambig_fix <- as.double(data$ambig_fix)
data$val_fix <- as.double(data$val_fix)

```

All subjects
```{r}
n_try = max(data$subid)
data_list <- list(
  choice = data$choice,
  prob = data$prob,
  ambig = data$ambig,
  val = data$val,
  prob_ref = data$prob_fix,
  ambig_ref = data$ambig_fix,
  val_ref = data$val_fix,
  id = data$subid
)

```

## individual fitting, no pooling
```{r}

# individual subjects, not multilevel
fit.choice.nopool <- ulam(
  alist(
    choice ~ dbinom(1, choice_prob), # sample from bernoulli distribution
    logit(choice_prob) <- (uL-uR)*slope[id],
    # choice_prob <- 1 / (1 + exp(slope[id]*(uL-uR))), # choice probablity of the lottery
    uL <- (prob - beta[id] * (ambig/2)) * val ^alpha[id], # subjective value of the lottery
    uR <- (prob_ref - beta[id] * (ambig_ref/2)) * val_ref ^alpha[id], # subjective value of the reference
    
    alpha[id] ~ dlnorm(-0.2, 0.5),
    beta[id] ~ dnorm(0.2, 2),
    slope[id] ~ dnorm(1, 3)
    
  ), 
  data = data_list, iter = 1e3, chains=4,
  start = list(alpha = rep(0.2, n_try), beta = rep(0.2, n_try), sigma = rep(1, n_try))
)

```

Look at model fitting result
```{r}
par.nopool <- data.frame(precis(fit.choice.nopool, depth=2))
# str(fit.choice)
 
# View(par.nopool)
```

```{r}
# no individual subject
# fit.choice <- ulam(
#   alist(
#     choice ~ dbinom(1, choice_prob), # sample from bernoulli distribution
#     logit(choice_prob) <- (uL-uR)*slope[id], # choice probablity of the lottery
#     uL <- (prob - beta * (ambig/2)) * val ^alpha, # subjective value of the lottery
#     uR <- (prob_ref - beta * (ambig_ref/2)) * val_ref ^alpha, # subjective value of the reference
#     
#     alpha ~ dnorm(0.5, 2),
#     beta ~ dnorm(0.2, 2),
#     slope ~ dnorm(1, 2)
#     
#   ), 
#   data = data_list, iter = 1e4, chains=4,
#   start = list(alpha = 0.5, beta = 0.2, sigma = 1)
# )
```

```{r}
y<-rexp(1000,1)
hist(y)
# hist(log(y))
```

```{r}

y<-rlnorm(1000,-0.5, 0.2)
hist(y)
# hist(log(y))
```

```{r}
y<-rnorm(1000,0.5, 0.2)
hist(y)
# hist(log(y))
```


## multilevel fitting, partial pooling
using ulam
```{r}

fit.choice.partpool <- ulam(
  alist(
    choice ~ dbinom(1, choice_prob), # sample from bernoulli distribution
    logit(choice_prob) <- (uL-uR)*slope[id],
    uL <- (prob - beta[id] * (ambig/2)) * val ^ alpha[id], # subjective value of the lottery
    uR <- (prob_ref - beta[id] * (ambig_ref/2)) * val_ref ^ alpha[id], # subjective value of the reference
    
    # alpha[id] ~ dlnorm(-miu_a, sigma_a), # （-0.2， 0.5）
    alpha[id] ~ dnorm(miu_a, sigma_a),
    beta[id] ~ dnorm(miu_b, sigma_b),
    slope[id] ~ dnorm(miu_s, sigma_s),

    # alpha[id] ~ dlnorm(-0.2, 0.5),
    # beta[id] ~ dnorm(0.2, 2),
    # slope[id] ~ dnorm(1, 3)        
    
    # group level priors
    # miu_a ~ dlnorm(-0.5, 0.2),
    miu_a ~ dlnorm(-0.5, 0.2),
    sigma_a ~ dexp(2),
    # sigma_a ~ dhalfnorm(0,1),

    miu_b ~ dnorm(0.2, 1),
    sigma_b ~ dexp(2),
    # sigma_b ~ dhalfnorm(0,1),

    miu_s ~ dnorm(1, 1),
    sigma_s ~ dexp(2)
    # sigma_s ~ dhalfnorm(0,1)

    
  ), 
  data = data_list, iter = 1e3, chains=3,
  start=list(miu_a=0.7, miu_b=0.7, miu_s=0.8, sigma_a = 0.5, sigma_b = 0.5, sigma_s = 0.5),
  control=list(adapt_delta=0.95)
)

```

Use map2stan
```{r}
fit.choice.partpool <- map2stan(
  alist(
    choice ~ dbinom(1, choice_prob), # sample from bernoulli distribution
    logit(choice_prob) <- (uL-uR)*slope[id],
    uL <- (prob - beta[id] * (ambig/2)) * val ^ alpha[id], # subjective value of the lottery
    uR <- (prob_ref - beta[id] * (ambig_ref/2)) * val_ref ^ alpha[id], # subjective value of the reference
    
    # alpha[id] ~ dlnorm(-miu_a, sigma_a), # （-0.2， 0.5）
    alpha[id] ~ dnorm(miu_a, sigma_a),
    beta[id] ~ dnorm(miu_b, sigma_b),
    slope[id] ~ dnorm(miu_s, sigma_s),

    # alpha[id] ~ dlnorm(-0.2, 0.5),
    # beta[id] ~ dnorm(0.2, 2),
    # slope[id] ~ dnorm(1, 3)        
    
    # group level priors
    # miu_a ~ dlnorm(-0.5, 0.2),
    miu_a ~ dlnorm(-0.5, 0.2),
    sigma_a ~ dexp(2),
    # sigma_a ~ dhalfnorm(0,1),

    miu_b ~ dnorm(0.2, 1),
    sigma_b ~ dexp(2),
    # sigma_b ~ dhalfnorm(0,1),

    miu_s ~ dnorm(1, 1),
    sigma_s ~ dexp(2)
    # sigma_s ~ dhalfnorm(0,1)

    
  ), 
  data = data_list, iter = 1e3, chains=4,
  start=list(miu_a=0.5, miu_b=0.5, miu_s=1, sigma_a = 1, sigma_b = 1, sigma_s = 1),
  control=list(adapt_delta=0.95)
)
```


Re-parameterize
using ulam
```{r}
fit.choice.partpool.repar <- ulam(
  alist(
    choice ~ dbinom(1, choice_prob), # sample from bernoulli distribution
    logit(choice_prob) <- (uL-uR)*(miu_s + sigma_s*param_s[id]),
    uL <- (prob - (miu_b + sigma_b*param_b[id]) * (ambig/2)) * val ^ (miu_a + sigma_a*param_a[id]), # subjective value of the lottery
    uR <- (prob_ref - (miu_b + sigma_b*param_b[id]) * (ambig_ref/2)) * val_ref ^ (miu_a + sigma_a*param_a[id]), # subjective value of the reference
    
    # standardized
    param_a[id] ~ dnorm(0,1),
    param_b[id] ~ dnorm(0,1),
    param_s[id] ~ dnorm(0,1),
    
    # group level priors
    miu_a ~ dhalfnorm(0.5, 0.3),
    sigma_a ~ dexp(2),

    miu_b ~ dnorm(0.2, 0.5),
    sigma_b ~ dexp(2),

    miu_s ~ dnorm(2, 1),
    sigma_s ~ dexp(2),
    
    gq> vector[id]:alpha <<- miu_a + sigma_a*param_a,
    gq> vector[id]:beta <<- miu_b + sigma_b*param_b,
    gq> vector[id]:slope <<- miu_s + sigma_s*param_s
  ), 
  data = data_list, iter = 1e3, chains=3,
  start=list(miu_a=0.3, miu_b=0.65, miu_s=0.6, sigma_a = 0.5, sigma_b = 1, sigma_s = 1),
  control=list(adapt_delta=0.95)
)

```

using map2stan
```{r}
fit.choice.partpool.repar <- map2stan(
  alist(
    choice ~ dbinom(1, choice_prob), # sample from bernoulli distribution
    logit(choice_prob) <- (uL-uR)*(miu_s + sigma_s*param_s[id]),
    uL <- (prob - (miu_b + sigma_b*param_b[id]) * (ambig/2)) * val ^ (miu_a + sigma_a*param_a[id]), # subjective value of the lottery
    uR <- (prob_ref - (miu_b + sigma_b*param_b[id]) * (ambig_ref/2)) * val_ref ^ (miu_a + sigma_a*param_a[id]), # subjective value of the reference
    
    # standardized
    param_a[id] ~ dnorm(0,1),
    param_b[id] ~ dnorm(0,1),
    param_s[id] ~ dnorm(0,1),
    
    # group level priors
    miu_a ~ dlnorm(-0.5, 0.2),
    sigma_a ~ dexp(2),

    miu_b ~ dnorm(0.2, 0.5),
    sigma_b ~ dexp(2),

    miu_s ~ dnorm(2, 1),
    sigma_s ~ dexp(2)
    
    # gq> vector[id]:alpha <<- miu_a + sigma_a*param_a,
    # gq> vector[id]:beta <<- miu_b + sigma_b*param_b,
    # gq> vector[id]:slope <<- miu_s + sigma_s*param_s
  ), 
  data = data_list, iter = 1e3, chains=4,
  start=list(miu_a=0.5, miu_b=0.5, miu_s=1, sigma_a = 1, sigma_b = 1, sigma_s = 1),
  control=list(adapt_delta=0.95)
)

```

Look at model fitting result
```{r}
par.partpool <- data.frame(precis(fit.choice.partpool, depth=2))
# str(fit.choice)
par.partpool.repar <- data.frame(precis(fit.choice.partpool.repar, depth=2))
# View(par.partpool)
# View(par.partpool.repar)

```

## Compare the no-pooling and part-pooling
```{r}

nopool <- data.frame(
  id = c(1:n_try),
  alpha = par.nopool$mean[1:n_try],
  beta = par.nopool$mean[(n_try + 1):(2*n_try)],
  slope = par.nopool$mean[(2*n_try + 1):(3*n_try)],
  method=rep('nopool', n_try)
)

partpool <- data.frame(
  id=c(1:n_try),
  alpha=par.partpool$mean[1:n_try],
  beta=par.partpool$mean[(n_try + 1):(2*n_try)],
  slope=par.partpool$mean[(2*n_try + 1):(3*n_try)],
  method=rep('partpool', n_try)
)

# re-parameterized model

partpool.repar <- data.frame(
  id=c(1:n_try),
  alpha=par.partpool.repar$mean[(1+6):(n_try+6)] * par.partpool.repar["sigma_a", "mean"] + par.partpool.repar["miu_a", "mean"],
  beta=par.partpool.repar$mean[(n_try + 1+6):(2*n_try+6)] * par.partpool.repar["sigma_b", "mean"] + par.partpool.repar["miu_b", "mean"],
  slope=par.partpool.repar$mean[(2*n_try + 1+6):(3*n_try+6)] * par.partpool.repar["sigma_s", "mean"] + par.partpool.repar["miu_s", "mean"],
  method=rep('partpool.repar', n_try)
)

# partpool.repar <- data.frame(
#   id=c(1:n_try),
#   alpha=par.partpool.repar$mean[(nrow(par.partpool.repar)-n_try+1):nrow(par.partpool.repar)],
#   beta=par.partpool.repar$mean[(nrow(par.partpool.repar)-2*n_try +1):(nrow(par.partpool.repar)-n_try)] ,
#   slope=par.partpool.repar$mean[(nrow(par.partpool.repar)-3*n_try+1):(nrow(par.partpool.repar)-2*n_try)],
#   method=rep('partpool.repar', n_try)
# )

compare <- rbind(nopool, partpool,partpool.repar)
```

```{r}
ggplot(compare, aes(x = id, y = alpha, color = method, fill = method)) + 
  geom_point(size = 3, alpha = 0.5)

ggplot(compare, aes(x = id, y = beta, color = method, fill = method)) + 
  geom_point(size = 3, alpha = 0.5)

ggplot(compare, aes(x = id, y = slope, color = method, fill = method)) + 
  geom_point(size = 3, alpha = 0.5)

# ggplot(partpool, aes(x = id, y = alpha)) + 
#   geom_point(size = 3)
```

